dist: bionic
language: python
# NOTE: when `language: python` is set, using `compiler: clang` or
# `compiler: gcc` does nothing. These only work when `language: cpp`.
python: 3.7
matrix:
  include:
    - env: TOXENV=py37
    - env: TOXENV=py37 CC=clang
    - env: TOXENV=flake8
    - env: TOXENV=format
    - env: TOXENV=mypy
    - env: TOXENV=docs
cache: pip
before_install:
  - python --version
  - if [[ -n $CC ]]; then $CC --version; fi
install:
  - pip install "poetry<2,>=1.0" tox
  - pip install "grpcio-tools~=1.8" "mypy-protobuf~=1.0"
  - make  # generate Python protobuf files
script:
  # NOTE: this first step will only test against Python 3.7. Need to generalize for Python 3.8
  - if [[ ${TOXENV:0:2} = "py" ]]; then poetry install -v && poetry run pytest -s -v --cov=httpstan --cov-fail-under=93 tests; fi
  - if [[ ${TOXENV:0:2} != "py" ]]; then tox; fi
