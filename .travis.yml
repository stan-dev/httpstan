dist: bionic
language: python
# NOTE: when `language: python` is set, using `compiler: clang` or
# `compiler: gcc` does nothing. These only work when `language: cpp`.
matrix:
  include:
    - python: 3.6
      env: TOXENV=py36 CC=clang
    - python: 3.7
      env: TOXENV=py37 CC=clang
    - python: 3.7
      env: TOXENV=coverage CC=clang

    - os: osx
      language: generic
      env: TRAVIS_PYTHON_VERSION=3.6 TOXENV=py36 CC=gcc
    - os: osx
      language: generic
      env: TRAVIS_PYTHON_VERSION=3.7 TOXENV=py37 CC=gcc
    - os: osx
      osx_image: xcode11
      language: generic
      env: TRAVIS_PYTHON_VERSION=3.6 TOXENV=py36 CC=clang
    - os: osx
      osx_image: xcode11
      language: generic
      env: TRAVIS_PYTHON_VERSION=3.7 TOXENV=py37 CC=clang

    - env: TOXENV=flake8
    - env: TOXENV=format
    - env: TOXENV=mypy
before_install:
  - |
    # install Python on macOS
    if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      env | sort
      if ! which python$TRAVIS_PYTHON_VERSION; then
        HOMEBREW_NO_AUTO_UPDATE=1 brew tap minrk/homebrew-python-frameworks
        HOMEBREW_NO_AUTO_UPDATE=1 brew cask install python-framework-${TRAVIS_PYTHON_VERSION/./}
      fi
      python3 -m pip install virtualenv
      python3 -m virtualenv -p $(which python$TRAVIS_PYTHON_VERSION) ~/travis-env
      source ~/travis-env/bin/activate
    fi
  - python --version
  - if [[ -n $CC ]]; then $CC --version; fi
install:
  - pip install cython tox coveralls grpcio-tools
  - make  # generate required C++ files
script:
  - travis_wait 60 tox
